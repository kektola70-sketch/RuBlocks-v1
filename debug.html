<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rublocks DEBUG</title>
    <style>
        body { background: #111; color: white; font-family: monospace; padding: 20px; }
        #console-box {
            background: black;
            border: 2px solid lime;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
            margin-top: 20px;
            white-space: pre-wrap;
            font-size: 12px;
        }
        button { padding: 10px; background: #333; color: white; border: 1px solid white; margin: 5px; }
        .log-line { border-bottom: 1px solid #333; padding: 2px; }
        .error { color: red; }
        .success { color: lime; }
    </style>
</head>
<body>

    <h1>Режим диагностики</h1>
    <p>Статус: <span id="status">Ожидание...</span></p>
    
    <div id="user-details">
        Ник: <span id="u-name">---</span><br>
        UID: <span id="u-uid">---</span>
    </div>

    <button id="logoutBtn">Выйти из аккаунта</button>
    <button onclick="window.location.reload()">Обновить страницу</button>
    <button onclick="window.location.href='index.html'">Вернуться на вход</button>

    <h3>Лог консоли (Скинь мне текст отсюда, если есть красное):</h3>
    <div id="console-box">Инициализация...</div>

    <script type="module">
        // Функция для записи логов на экран
        const consoleBox = document.getElementById('console-box');
        function log(msg, type = 'normal') {
            const div = document.createElement('div');
            div.className = 'log-line ' + type;
            div.innerText = `> ${msg}`;
            consoleBox.appendChild(div);
            consoleBox.scrollTop = consoleBox.scrollHeight;
            console.log(msg);
        }

        log("Подключаем Firebase...", "normal");

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBtElNGI8_4BSDO2XRnTjSw7AnjDQb83Kk",
          authDomain: "rublocks-v1.firebaseapp.com",
          projectId: "rublocks-v1",
          storageBucket: "rublocks-v1.firebasestorage.app",
          messagingSenderId: "571591636842",
          appId: "1:571591636842:web:c450a1c15ec983fd535713",
          measurementId: "G-82D3V3YJ7V"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            log("Firebase подключен успешно.", "success");

            // Проверка авторизации
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    log("Пользователь найден: " + user.email, "success");
                    document.getElementById('u-uid').innerText = user.uid;

                    log("Попытка чтения из базы данных...", "normal");

                    try {
                        const userRef = doc(db, "users", user.uid);
                        const snap = await getDoc(userRef);

                        if (snap.exists()) {
                            const data = snap.data();
                            log("Данные загружены! Ник: " + data.username, "success");
                            document.getElementById('u-name').innerText = data.username;
                            document.getElementById('status').innerText = "ВСЁ РАБОТАЕТ";
                            document.getElementById('status').style.color = "lime";
                        } else {
                            log("Данных нет. Пробую создать...", "normal");
                            await setDoc(userRef, {
                                username: "Player_" + user.uid.slice(0,5),
                                email: user.email,
                                uid: user.uid,
                                isOnline: true
                            });
                            log("Профиль создан успешно!", "success");
                            document.getElementById('status').innerText = "ПРОФИЛЬ СОЗДАН";
                        }
                    } catch (dbError) {
                        log("ОШИБКА БАЗЫ ДАННЫХ: " + dbError.code, "error");
                        log("Текст ошибки: " + dbError.message, "error");
                        
                        if (dbError.code === 'permission-denied') {
                            log("РЕШЕНИЕ: Зайди в Firestore -> Rules и поставь 'allow read, write: if true;'", "error");
                        } else if (dbError.code === 'unimplemented') {
                             log("РЕШЕНИЕ: База данных не создана. Зайди в консоль и нажми Create Database.", "error");
                        }
                    }

                } else {
                    log("Пользователь НЕ авторизован.", "error");
                    document.getElementById('status').innerText = "Нет входа";
                    log("Нажми кнопку 'Вернуться на вход' и войди заново.", "normal");
                }
            });

            // Кнопка выхода
            document.getElementById('logoutBtn').addEventListener('click', () => {
                signOut(auth).then(() => log("Вышли из аккаунта", "normal"));
            });

        } catch (e) {
            log("КРИТИЧЕСКАЯ ОШИБКА: " + e.message, "error");
        }

    </script>
</body>
</html>